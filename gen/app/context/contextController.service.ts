// Generated by ContextControllerGenerator

// Is the central service of the Context Manager
// It initializes the context providers and refreshes the context profiles with new data

// Timer lengths can be adjusted above the constructor
// For permanent changes please refer to the generator file "IFML2NG2/src/imfl.generator.ng2/ifml.generator...context/ContextControllerGenerator.xtend"

import { Injectable, Input } from '@angular/core';
import { Subscription } from 'rxjs/Subscription';
import { Observable } from 'rxjs/Rx';
import { BehaviorSubject } from 'rxjs/Rx';
import { Profile } from './profile/profile';

import { DisplayProperties } from '../helper/displayProperties'

import { NoolsService } from '../services/nools.service';

import { UserDataService } from './providers/userData.service';
import { FaceDetectionService } from './providers/faceDetection.service';
import { DeviceAPIService } from './providers/deviceAPI.service';
import { GeocodingService } from './providers/geocoding.service';
import { AppStateService } from './providers/appState.service';

@Injectable()
export class ContextControllerService{
	
    private profile: Profile;
    
    private session: any;
    
    private active: boolean = true;
    
    private changed: boolean = false;
    private _changedSubject: BehaviorSubject<boolean> = new BehaviorSubject(false);
    public changedSubject: Observable<boolean> = this._changedSubject.asObservable();
    
    private age: Subscription;
    private gender: Subscription;
    private mood: Subscription;
    private faceDetected: Subscription;
    private language: Subscription;
    private ambientLight: Subscription;
    private movement: Subscription;
    private location: Subscription;
    private weather: Subscription;
    private deviceType: Subscription;
    private moodChecked: Subscription;
    private outsideChecked: Subscription;
    private userRole: Subscription;
    
	private timeInit: number = 0;      //initialization for the Timer
	private timeFast: number = 750;    //update Time for the Fast Update in ms
	private timeSlow: number = 8000;   //update Time for the Slow Update in ms
	
	
	constructor(
		private flow: NoolsService,
		private userDataService: UserDataService,
		private faceDetectionService: FaceDetectionService,
		private deviceAPIService: DeviceAPIService,
		private geocodingService: GeocodingService,
		private appStateService: AppStateService
	){
		
		this.profile = new Profile();
		this.flow.setProfile(this.profile);
		
		this.session = this.flow.getSession();
		
		this.age = this.faceDetectionService.ageSubject.subscribe(age => {
			if(this.active){
				this.profile.getUser().setAge(age);
				this.onModified();
			}
		});
		this.gender = this.faceDetectionService.genderSubject.subscribe(gender => {
			if(this.active){
				this.profile.getUser().setGender(gender);
				this.onModified();
			}
		});
		this.mood = this.faceDetectionService.moodSubject.subscribe(mood => {
			if(this.active){
				this.profile.getUser().setMood(mood);
				this.onModified();
			}
		});
		this.faceDetected = this.faceDetectionService.faceDetectedSubject.subscribe(faceDetected => {
			if(this.active){
				this.profile.getUser().setFaceDetected(faceDetected);
				this.onModified();
			}
		});
		this.language = this.deviceAPIService.languageSubject.subscribe(language => {
			if(this.active){
				this.profile.getUser().setLanguage(language);
				this.onModified();
			}
		});
		this.ambientLight = this.deviceAPIService.ambientLightSubject.subscribe(ambientLight => {
			if(this.active){
				this.profile.getEnvironment().setAmbientLight(ambientLight);
				this.onModified();
			}
		});
		this.movement = this.deviceAPIService.movementSubject.subscribe(movement => {
			if(this.active){
				this.profile.getEnvironment().setMovement(movement);
				this.onModified();
			}
		});
		this.location = this.geocodingService.locationSubject.subscribe(location => {
			if(this.active){
				this.profile.getEnvironment().setLocation(location);
				this.onModified();
			}
		});
		this.weather = this.geocodingService.weatherSubject.subscribe(weather => {
			if(this.active){
				this.profile.getEnvironment().setWeather(weather);
				this.onModified();
			}
		});
		this.deviceType = this.deviceAPIService.deviceTypeSubject.subscribe(deviceType => {
			if(this.active){
				this.profile.getPlatform().setDeviceType(deviceType);
				this.onModified();
			}
		});
		this.moodChecked = this.appStateService.moodCheckedSubject.subscribe(moodChecked => {
			if(this.active){
				this.profile.getApp().setMoodChecked(moodChecked);
				this.onModified();
			}
		});
		this.outsideChecked = this.appStateService.outsideCheckedSubject.subscribe(outsideChecked => {
			if(this.active){
				this.profile.getApp().setOutsideChecked(outsideChecked);
				this.onModified();
			}
		});
		this.userRole = this.appStateService.userRoleSubject.subscribe(userRole => {
			if(this.active){
				this.profile.getApp().setUserRole(userRole);
				this.onModified();
			}
		});
	
		//Manager checks APIs fast
		let timerFast = Observable.timer(this.timeInit,this.timeFast);
		timerFast.subscribe(t => {
		    //console.log(t);
		    if(this.active){
		    	this.fast();
		    }
		});
		
		//Manager checks APIs slow
		let timerSlow = Observable.timer(this.timeInit,this.timeSlow);
		timerSlow.subscribe(t => {
		    //console.log(t);
		    if(this.active){
		    	this.slow();
		    }
		});
		
	}
	
	fast(){
		this.faceDetectionService.getAge();
		this.faceDetectionService.getGender();
		this.faceDetectionService.getMood();
		this.faceDetectionService.getFaceDetected();
		this.deviceAPIService.getAmbientLight();
		this.deviceAPIService.getMovement();
		this.appStateService.getUserRole();
	}
	
    slow(){
		this.deviceAPIService.getLanguage();
		this.geocodingService.getLocation();
		this.geocodingService.getWeather();
		this.deviceAPIService.getDeviceType();
		this.appStateService.getMoodChecked();
    }
    
    //returns Profile instance
	public getProfile(){
	    return this.profile;
	}
	
	public onModified(){
	  //now fire the rules
	  this.session.assert(this.getProfile());
	  this.session.match(function(err){
	      if(err){
	        console.error(err.stack);
	      }
	  });
	  this.changed = true;
	  this._changedSubject.next(this.changed);
	}
	
	public setActivation( status ){
		this.active = status;
	}
	
	public setNotChanged(){
		this.changed = false;
	}
}			
